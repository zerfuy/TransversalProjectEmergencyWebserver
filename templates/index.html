
<!DOCTYPE html>
<html>
<head>
    
    <title>Quick Start - Leaflet</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/leaflet.css' ) }}">
    
    <script type="text/javascript" src="{{ url_for('static', filename = 'js/leaflet.js') }}"></script>

</head>
<body>



<div id="mapid" style="width: 1000px; height: 700px;"></div>
<script>

    var map = L.map('mapid').setView([45.784680, 4.893310], 13);

    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: 'Jui un stremon'
    }).addTo(map);

    L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        id: 'mapbox/streets-v11'
    }).addTo(map);

    var fire_engines = JSON.parse('{{ fire_engines}}');
    var fromTo = JSON.parse('{{ fromTo}}');
    
    //display all routes
    fromTo.forEach(function(elem){
        from = elem[0];
        to = elem[1];
        fetch("http://router.project-osrm.org/route/v1/driving/" + from[1] + "," + from[0] + ";" + to[1] + "," + to[0] + "?overview=full")
        .then(function(response) {
            if(response.ok){
                ret = response.json();
                console.log("ans ok");
                return ret;
            }else{
                console.log("ans nok");
            }
        })
        .then(function(ret){
            let points = decode(ret.routes[0].geometry, 5);
            var polyline = new L.Polyline(points).addTo(map);
        });
    })
    
    

    //display all trucks
    fire_engines.forEach(function(elem){
        L.marker([elem[0], elem[1]]).addTo(map)
        .bindPopup("Fire engine")
    });

    L.circle([51.508, -0.11], 500, {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.5
    }).addTo(map).bindPopup("Ongoing Fire");


    var popup = L.popup();

    function onMapClick(e) {
        popup
            .setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(map);
    }

    map.on('click', onMapClick);

function decode(str, precision) {
    var index = 0,
        lat = 0,
        lng = 0,
        coordinates = [],
        shift = 0,
        result = 0,
        byte = null,
        latitude_change,
        longitude_change,
        factor = Math.pow(10, precision || 5);

    while (index < str.length) {

        // Reset shift, result, and byte
        byte = null;
        shift = 0;
        result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        shift = result = 0;

        do {
            byte = str.charCodeAt(index++) - 63;
            result |= (byte & 0x1f) << shift;
            shift += 5;
        } while (byte >= 0x20);

        longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

        lat += latitude_change;
        lng += longitude_change;

        coordinates.push([lat / factor, lng / factor]);
    }

    return coordinates;
};
</script>



</body>
</html>
